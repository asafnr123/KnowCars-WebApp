apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: develop
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      initContainers:
        - name: wait-for-api
          image: busybox
          imagePullPolicy: Always
          command:
            - sh
            - -c
            - |
              MAX_RETRIES=10
              COUNT=0
              
              while true; do
                if wget -qO- http://flask-service:5000/api/health 2>/dev/null | grep -q '"message":"Ready"'; then
                  echo "Flask API is ready"
                  break
                fi

                echo "waiting for flask-api"
                sleep 2
                COUNT=$((COUNT + 1))
                if [ $COUNT -eq $MAX_RETRIES ]; then
                  echo "Nginx failed to launch after $COUNT retries"
                  exit 1
                fi
                done
 
      containers:
        - name: nginx
          image: asafnr567/nginx-srv:1.1
          imagePullPolicy: Always
          ports:
            - containerPort: 80
